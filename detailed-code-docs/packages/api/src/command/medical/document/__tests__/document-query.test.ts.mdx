---
title: "document-query.test.ts"
---

## High-level description
This file contains unit tests for the `document-query` module, specifically for the `getOrGenerateRequestId` function and a placeholder for `queryDocumentsAcrossHIEs`. It ensures the correct behavior of generating new request IDs for document queries and reusing existing ones when appropriate.

## Code Structure
The code defines a test suite using `describe` blocks for grouping related tests. It sets up mocks and spies before each test to isolate the functions under test. The `getOrGenerateRequestId` function is tested with various scenarios of document query progress, while `queryDocumentsAcrossHIEs` has a placeholder test.

## References
- `uuidv7_file`: References the `uuidv7` function from the `@metriport/core/util/uuid-v7` module for generating UUIDs.
- `makeDocumentQueryProgress`: References a helper function likely used to create mock document query progress objects for testing.
- `PatientModel`: References the Sequelize model for patients, used in a mocked function call.
- `mockStartTransaction`: References a helper function likely used to mock database transactions within tests.
- `whMedical.processPatientDocumentRequest`: References a function from the `document-webhook` module, mocked to prevent side effects during testing.

## Symbols

### `getOrGenerateRequestId`
#### Description
This function determines the request ID to use for a document query. It either returns a new UUID if there's no previous query progress or if the previous download and convert processes are completed/failed. Otherwise, it reuses the existing request ID.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| docQueryProgress | object \| undefined | An optional object representing the progress of a previous document query. |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| requestId | string | The determined request ID for the document query. |

#### Internal Logic
1. If `docQueryProgress` is undefined, generate a new UUID using `uuidv7_file.uuidv4()` and return it.
2. If `docQueryProgress.download.status` or `docQueryProgress.convert.status` is "processing", return `docQueryProgress.requestId`.
3. Otherwise, generate a new UUID and return it.

### `queryDocumentsAcrossHIEs`
#### Description
This function is a placeholder for the actual implementation of querying documents across different HIEs.

#### Internal Logic
The test for this function is currently marked as "TODO" and doesn't have any assertions, indicating it's not yet implemented.
