---
title: "document-query.test.part.ts"
---

## High-level description
The code defines a suite of end-to-end (E2E) tests for the document query functionality of the medical API. It covers triggering a document query, verifying its successful completion, and checking for expected data on the FHIR server. Additionally, it includes a test for deleting a patient's consolidated data.

## Code Structure
The `runDocumentQueryTests` function serves as a container for multiple test cases, each defined using the `it` function. These tests interact with the `medicalApi` to perform actions like starting a document query, checking its status, and listing documents. The tests also utilize helper functions like `areDocumentsProcessing` to determine the status of the document query.

## References
- `medicalApi`: An instance of `MetriportMedicalApi` used to interact with the medical API.
- `fhirApi`: An instance of `MedplumClient` used to interact with the FHIR server.
- `e2e`: An object of type `E2eContext` containing test context data like patient and facility information.

## Symbols
### `runDocumentQueryTests`
#### Description
This function encapsulates a suite of end-to-end tests for the document query functionality.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| e2e | `E2eContext` | An object containing test context data like patient and facility information. |

#### Outputs
This function does not return any value.

#### Internal Logic
The function defines four test cases:
1. **"triggers a document query"**: Starts a document query for a given patient and facility and verifies that the query is in progress.
2. **"gets successful response from document query"**: Waits for the document query to complete successfully and then retrieves the list of documents. It asserts that the number of retrieved documents matches the expected count.
3. **"contains expected data on FHIR server"**: This test case is marked as TODO and needs to be implemented.
4. **"deletes a patient's consolidated data"**: Retrieves a patient's consolidated data, iterates through the entries, and deletes each resource from the FHIR server. Finally, it verifies that the count of consolidated data for the patient is zero.

## Dependencies
- `@metriport/core/external/fhir/document/document-reference`: Used for checking if a resource is a `DocumentReference`.
- `@metriport/shared`: Provides the `sleep` function for pausing execution.
- `dayjs`: A library for handling dates and times.
- `dayjs/plugin/duration`: A plugin for `dayjs` to handle durations.
- `dayjs/plugin/isBetween`: A plugin for `dayjs` to check if a date is between two other dates.
- `@metriport/api-sdk`: Provides the `MetriportMedicalApi` class for interacting with the medical API.
- `@medplum/core`: Provides the `MedplumClient` class for interacting with the FHIR server.

## Error Handling
The code includes basic error handling using `try...catch` blocks within the test cases. If an error occurs during the execution of a test case, it will be caught and reported.

## Logging
The code utilizes `console.log` to provide status updates during the execution of the document query. It logs messages indicating the progress of the query and any retries attempted.
