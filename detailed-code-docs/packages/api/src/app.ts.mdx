---
title: "app.ts"
---

## High-level description
This code defines the main Express application for the Metriport API. It sets up middleware, routes, error handling, and initializes various components such as the database, feature flags, and Sentry for error tracking. The application is designed to handle both API key-based and OAuth-based authentication for different routes.

## Code Structure
The main `app.ts` file sets up the Express application, configures middleware, mounts routes, and initializes various components. It imports and uses several other modules for specific functionalities such as error handling, database initialization, and feature flag management.

## Symbols

### `app`
#### Description
The main Express application instance.

#### Internal Logic
1. Initializes Sentry for error tracking
2. Sets up middleware (helmet, cors, JSON parsing)
3. Mounts routes
4. Sets up error handling
5. Initializes database connection and feature flags

### `server`
#### Description
The HTTP server instance created from the Express app.

#### Internal Logic
1. Listens on the specified port
2. Initializes database connection and feature flags on startup
3. Configures server timeouts and keep-alive settings

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| dotenv | Load environment variables |
| express | Web application framework |
| helmet | Security middleware |
| cors | Cross-Origin Resource Sharing middleware |
| dayjs | Date manipulation library |
| @sentry/node | Error tracking and monitoring |

## Configuration
The application uses various configuration options, mostly loaded from environment variables through the `Config` class. Key configurations include:

- Database credentials
- AWS settings
- Sentry DSN
- API version
- Server port and timeout settings

## Error Handling
The application uses a custom error handler (`errorHandler`) that formats errors according to RFC 7807. It also integrates with Sentry for error tracking and reporting.

## Logging
The application uses console logging for startup information and errors. It also integrates with Sentry for more detailed error tracking and monitoring.

## TODOs
- Review the tracing sample rate based on the load on the app and Sentry's quotas (TODO #499)