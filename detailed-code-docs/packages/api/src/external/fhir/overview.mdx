---
title: "Overview"
---

## High-level description
This directory contains code for interacting with FHIR (Fast Healthcare Interoperability Resources) servers and managing FHIR resources within the Metriport API. It provides functionality for creating and managing tenants, converting and handling various FHIR resources (such as DocumentReferences, Organizations, and Patients), and includes shared utilities for error handling, JSON validation, and pagination.

## What does it do?
The code in this directory performs several key functions:

1. FHIR Server Interaction: It provides connectors for communicating with FHIR servers, supporting both direct HTTP communication and AWS SQS-based messaging for cloud environments.

2. Tenant Management: It includes functionality to create and manage tenants on the FHIR server, essential for multi-tenant applications.

3. Resource Conversion and Handling: It converts various healthcare data formats (e.g., CommonWell) to FHIR-compliant resources and manages operations like creating, updating, and retrieving these resources.

4. Document Management: It handles FHIR DocumentReference resources, including conversion from other formats, creation of temporary references during uploads, and retrieval.

5. Organization and Patient Management: It provides functions to convert internal organization and patient data to FHIR format and update these resources on the FHIR server.

6. Resource Counting: It offers functionality to count FHIR resources associated with patients or customers, useful for analytics and reporting.

7. Error Handling and Validation: It includes shared utilities for error mapping, JSON validation of FHIR resources, and handling FHIR-specific errors.

8. Pagination: It provides utilities for handling paginated responses from FHIR servers, allowing retrieval of large datasets.

These functionalities work together to provide a comprehensive interface for managing healthcare data in FHIR format, ensuring interoperability with other healthcare systems and maintaining data integrity.

## Entry points
The main entry points for this directory are:

1. `connector/connector-factory.ts`: Creates FHIR server connectors based on the environment.
2. `admin.ts`: Provides functions for tenant management.
3. `document/index.ts`: Handles conversion and management of DocumentReference resources.
4. `organization/index.ts`: Manages conversion and updates of Organization resources.
5. `patient/count-resources.ts` and `patient/upsert-patient.ts`: Handle patient-related operations.
6. `shared/error-mapping.ts` and `shared/json-validator.ts`: Provide shared utilities for error handling and validation.

## Key Files
1. `connector/connector-factory.ts`: Creates FHIR server connectors.
2. `admin.ts`: Manages FHIR server tenants.
3. `document/index.ts`: Converts and manages DocumentReference resources.
4. `organization/index.ts`: Converts and updates Organization resources.
5. `patient/count-resources.ts`: Counts FHIR resources for patients or customers.
6. `patient/upsert-patient.ts`: Updates or inserts patient records in the FHIR server.
7. `shared/error-mapping.ts`: Maps and categorizes FHIR errors.
8. `shared/json-validator.ts`: Validates FHIR resources against JSON schema.
9. `shared/paginated.ts`: Handles pagination of FHIR resources.

## Dependencies
The code relies on several external libraries and frameworks:

1. @medplum/core and @medplum/fhirtypes: Provide FHIR-specific functionality and type definitions.
2. aws-sdk: Used for interacting with AWS services like S3 and SQS.
3. dayjs: Used for date and time manipulation.
4. lodash: Provides utility functions for object manipulation.
5. Ajv: Used for JSON schema validation.
6. uuid: Used for generating and validating UUIDs.
7. @faker-js/faker: Used for generating random data in tests.

Internal dependencies include various utility functions and types from other parts of the Metriport codebase.

## Configuration
The code uses configuration values provided by a `Config` object, which likely retrieves settings from environment variables. Key configuration options include:

1. FHIR server URL
2. AWS region and S3 bucket names
3. SQS queue URL for cloud environments

Error handling is implemented throughout the code, with custom error classes and logging utilities used for detailed error reporting and debugging.

In summary, this directory provides a comprehensive set of tools and utilities for managing FHIR resources within the Metriport API, enabling seamless integration with FHIR-compliant healthcare systems and maintaining data integrity across various healthcare data formats.