---
title: "run-or-schedule-patient-discovery.test.ts"
---

## High-level description
This file contains unit tests for the `runInitialPatientDiscoveryAcrossHies` and `runOrSchedulePatientDiscoveryAcrossHies` functions. These tests verify the behavior of patient discovery processes across different Health Information Exchanges (HIEs) under various conditions and flag configurations.

## Code Structure
The code is structured into two main test suites, each focusing on a specific function. Both suites use Jest for testing and mock various dependencies to isolate the tested functionality.

## Symbols

### `beforeEach`
#### Description
This function sets up the test environment before each test case. It mocks various functions and models used in the tested code.

#### Internal Logic
- Mocks the `startTransaction` function
- Sets up spy instances for `PatientModel.findOne`, `cqPatient.discover`, `cwPatient.create`, `cqRunSchedule.runOrScheduleCqPatientDiscovery`, and `cwRunOrSchedule.runOrScheduleCwPatientDiscovery`

### `afterEach`
#### Description
This function cleans up the test environment after each test case.

#### Internal Logic
- Clears all mocks

### `describe("run initial patient discovery")`
#### Description
This test suite focuses on the `runInitialPatientDiscoveryAcrossHies` function.

#### Internal Logic
- Creates a test patient and base parameters
- Tests the function with undefined flags
- Tests the function with flags set to false
- Tests the function with flags set to true

### `describe("run initial patient discovery")` (second occurrence)
#### Description
This test suite focuses on the `runOrSchedulePatientDiscoveryAcrossHies` function.

#### Internal Logic
- Creates a test patient and base parameters
- Tests the function with undefined flags
- Tests the function with flags set to false
- Tests the function with flags set to true

### Individual test cases (`it` blocks)
#### Description
Each test case verifies the behavior of the tested function under specific conditions.

#### Internal Logic
- Sets up the test environment with specific parameters
- Calls the function being tested
- Verifies that the appropriate mock functions were called with the expected parameters

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| jest | Testing framework |
| @metriport/core | Core functionality and types |
| ../../../domain/medical/__tests__/patient | Patient test utilities |
| ../../../models/medical/patient | Patient model |
| ../../../models/__tests__/transaction | Transaction mocking utilities |
| ../../../external/carequality/patient | Carequality patient operations |
| ../../../external/commonwell/patient | CommonWell patient operations |
| ../../../external/carequality/command/run-or-schedule-patient-discovery | Carequality patient discovery scheduling |
| ../../../external/commonwell/command/run-or-schedule-patient-discovery | CommonWell patient discovery scheduling |
| ../run-initial-patient-discovery | Initial patient discovery across HIEs |
| ../run-or-schedule-patient-discovery | Patient discovery scheduling across HIEs |
| ../cross-hie-ids | Cross-HIE ID utilities |