---
title: "Overview"
---

## High-level description
This directory contains modules for managing Carequality (CQ) integration within the API. It provides functionality for handling patient data, outbound responses, and patient discovery processes related to the Carequality network. The code is designed to work with a database, likely using Sequelize as an ORM, and implements operations to ensure data integrity and consistency.

## What does it do?
The code in this directory performs several key functions related to Carequality integration:

1. Manages CQ patient data:
   - Creates, updates, retrieves, and deletes CQ patient records, including patient links and demographics history.
   - Ensures data consistency through database transactions.

2. Handles outbound responses:
   - Creates and retrieves responses for document queries, document retrievals, and patient discoveries.
   - Standardizes payload structures for different types of responses.

3. Orchestrates patient discovery:
   - Determines whether to run patient discovery immediately or schedule it for later execution.
   - Updates patient discovery status and associated parameters.

4. Manages the CQ directory:
   - Creates, updates, and searches for organizations and facilities in the CQ directory.
   - Rebuilds the entire CQ directory by fetching and processing data from the Carequality Management API.

These functionalities are crucial for maintaining up-to-date patient information, facilitating data exchange within the Carequality network, and ensuring accurate records of interactions with external systems.

## Entry points
The main entry points for this directory include:

1. `runOrScheduleCqPatientDiscovery`: Orchestrates the patient discovery process.
2. `updatePatientDiscoveryStatus`: Updates the CQ integration status for a patient.
3. Functions for creating and retrieving outbound responses (document queries, retrievals, and patient discoveries).
4. Functions for managing the CQ directory (creation, updates, searches, and rebuilding).

## Key Files
1. `run-or-schedule-patient-discovery.ts`: Contains the main logic for orchestrating patient discovery.
2. `update-patient-discovery-status.ts`: Handles updating patient discovery status and parameters.
3. Files in the `cq-patient-data` subdirectory: Manage CQ patient data operations.
4. Files in the `outbound-resp` subdirectory: Handle creation and retrieval of outbound responses.
5. Files in the `cq-directory` subdirectory: Manage CQ directory operations.

## Dependencies
The code relies on several external libraries and internal modules:

1. `@metriport/carequality-sdk`: Provides types and utilities for Carequality API interactions.
2. `@metriport/core`: Offers core utilities for logging, notifications, and AWS interactions.
3. `@metriport/shared`: Provides shared utilities for error handling and data normalization.
4. `sequelize`: Used for database interactions and ORM functionality.
5. `@metriport/ihe-gateway-sdk`: Provides types for IHE gateway interactions.
6. Internal modules for patient management, error handling, and database operations.

## Configuration
The code uses several configuration settings and environment variables:

1. `CQ_URLS_TO_EXCLUDE`: An environment variable for URLs to exclude from CQ directory searches.
2. `DEFAULT_RADIUS_IN_MILES`: A constant for default search radius in CQ directory searches.
3. Database configuration: Relies on Sequelize configuration for database connections and operations.
4. Carequality API configuration: Settings for interacting with the Carequality Management API.

## Error Handling
The code implements error handling throughout its functions:

1. Custom error classes like `NotFoundError` are used for specific error conditions.
2. The `capture.error` function is used to log and report errors.
3. Try-catch blocks handle potential errors during database operations and API interactions.
4. Error messages are logged for debugging purposes.
5. Database transactions ensure data consistency and allow for rollbacks in case of errors.

In summary, this directory provides a comprehensive set of functions for managing Carequality integration within the API. It handles patient data, outbound responses, patient discovery processes, and CQ directory management, ensuring data integrity and facilitating seamless interaction with the Carequality network.