---
title: "cw.run-or-schedule-patient-discovery.test.ts"
---

## High-level description
This file contains unit tests for the `runOrScheduleCwPatientDiscovery` function, which is responsible for either running or scheduling a patient discovery process for CommonWell Health Alliance. The tests cover various scenarios, including cases with no previous patient discovery, completed discovery, failed discovery, and processing discovery with and without scheduling.

## Code Structure
The test file is structured using Jest, with a main `describe` block containing multiple `it` blocks for different test cases. The tests use mocking to simulate different scenarios and verify the expected behavior of the `runOrScheduleCwPatientDiscovery` function.

## Symbols

### `beforeEach`
#### Description
This function sets up the test environment before each test case by mocking various functions and models.

#### Internal Logic
1. Mocks the `startTransaction` function.
2. Mocks the `PatientModel.findOne` method.
3. Mocks the `cwPatient.update` method.
4. Mocks the `schedulePatientDiscovery.schedulePatientDiscovery` method.
5. Mocks the `CQDirectoryEntryModel.findAll` method.

### `afterEach`
#### Description
This function clears all mocks after each test case.

### `describe("run or schedule patient discovery")`
#### Description
This is the main test suite for the `runOrScheduleCwPatientDiscovery` function.

### `it("runs with no previous patient discovery")`
#### Description
Tests the scenario where there is no previous patient discovery.

#### Internal Logic
1. Mocks a patient with no previous discovery.
2. Calls `runOrScheduleCwPatientDiscovery` with the mocked patient.
3. Expects `cwUpdate_mock` to be called and `schedulePatientDiscovery_mock` not to be called.

### `it("runs with previous patient discovery completed")`
#### Description
Tests the scenario where there is a previous completed patient discovery.

#### Internal Logic
1. Mocks a patient with a completed discovery status.
2. Calls `runOrScheduleCwPatientDiscovery` with the mocked patient.
3. Expects `cwUpdate_mock` to be called and `schedulePatientDiscovery_mock` not to be called.

### `it("runs with previous patient discovery failed")`
#### Description
Tests the scenario where there is a previous failed patient discovery.

#### Internal Logic
1. Mocks a patient with a failed discovery status.
2. Calls `runOrScheduleCwPatientDiscovery` with the mocked patient.
3. Expects `cwUpdate_mock` to be called and `schedulePatientDiscovery_mock` not to be called.

### `it("runs with previous patient discovery processsing and no schedule")`
#### Description
Tests the scenario where there is a previous processing patient discovery without scheduling.

#### Internal Logic
1. Mocks a patient with a processing discovery status.
2. Calls `runOrScheduleCwPatientDiscovery` with the mocked patient.
3. Expects `cwUpdate_mock` not to be called and `schedulePatientDiscovery_mock` to be called with specific parameters.

### `it("runs with previous patient discovery processsing and schedule")`
#### Description
Tests the scenario where there is a previous processing patient discovery with scheduling.

#### Internal Logic
1. Mocks a patient with a processing discovery status and a scheduled patient discovery.
2. Calls `runOrScheduleCwPatientDiscovery` with the mocked patient.
3. Expects both `cwUpdate_mock` and `schedulePatientDiscovery_mock` not to be called.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| @metriport/core/external/index | Imports `MedicalDataSource` enum |
| @metriport/core/domain/patient-discovery | Imports `DiscoveryParams` and `ScheduledPatientDiscovery` types |
| ../../../domain/medical/__tests__/patient | Imports `makePatient` and `makePatientData` helper functions |
| ../../../models/medical/patient | Imports `PatientModel` |
| ../../carequality/models/cq-directory | Imports `CQDirectoryEntryModel` |
| ../../../models/__tests__/transaction | Imports `mockStartTransaction` function |
| ../patient | Imports patient-related functions |
| ../../hie/schedule-patient-discovery | Imports `schedulePatientDiscovery` function |
| ../command/run-or-schedule-patient-discovery | Imports `runOrScheduleCwPatientDiscovery` function |
| ../../hie/cross-hie-ids | Imports `getCqOrgIdsToDenyOnCw` function |

## Error Handling
This test file does not implement specific error handling mechanisms beyond the standard Jest error reporting.