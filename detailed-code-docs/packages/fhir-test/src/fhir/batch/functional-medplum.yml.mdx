---
title: "functional-medplum.yml"
---

## High-level description
This YAML file defines a configuration for running functional tests on a FHIR (Fast Healthcare Interoperability Resources) batch operation using Artillery, a load testing tool. It sets up authentication, performs a batch operation, and then verifies the creation of various FHIR resources.

## Code Structure
The YAML file is structured into several main sections: `config`, `before`, and `scenarios`. These sections define the test environment, authentication process, and the actual test scenarios to be executed.

## Symbols

### config
#### Description
Configures the test environment, including the target URL, HTTP timeout, plugins, test phases, and variables.

#### Internal Logic
- Sets the target URL from an environment variable
- Configures HTTP timeout and plugins (CloudWatch metrics and expect)
- Defines a single test phase with a duration of 1 and arrival count of 1
- Sets up a random string variable for code challenge

### before
#### Description
Defines the authentication flow to obtain an access token before running the test scenarios.

#### Internal Logic
1. Performs a POST request to `/auth/login` with user credentials
2. Captures the authorization code from the response
3. Exchanges the code for an access token using a POST request to `/oauth2/token`
4. Captures the access token for use in subsequent requests

### scenarios
#### Description
Defines the main test scenario for the FHIR Batch operation.

#### Internal Logic
1. Executes a `makeBodyFunctional` function before the scenario (defined in an external JavaScript file)
2. Posts a batch request to the FHIR endpoint
3. Reposts the same batch request and checks for operation outcomes
4. Performs GET requests to verify the creation of various FHIR resources (e.g., Condition, Observation, Procedure, etc.)
5. Each GET request includes an expectation for a 200 status code

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| Artillery | Load testing and functional testing framework |
| publish-metrics plugin | Publishes metrics to CloudWatch |
| expect plugin | Provides assertion capabilities for responses |
| batch.js | External JavaScript file containing custom functions |

## Configuration
| Option | Type | Default | Description |
|:-------|:-----|:--------|:------------|
| MEDPLUM_URL | string | N/A | Target URL for the Medplum FHIR server |
| MEDPLUM_USER | string | N/A | Username for authentication |
| MEDPLUM_PASSWORD | string | N/A | Password for authentication |
| REGION | string | N/A | AWS region for CloudWatch metrics |

## Error Handling
The test scenario includes basic error handling through status code expectations. Each request expects specific status codes (200 or 201) to pass the test.

## TODOs
The file includes commented-out sections for additional resource checks (Claim, ExplanationOfBenefit, Encounter, Immunization) that are not currently implemented or generated by the system under test.