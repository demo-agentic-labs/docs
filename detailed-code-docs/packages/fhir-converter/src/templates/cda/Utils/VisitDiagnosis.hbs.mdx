---
title: "VisitDiagnosis.hbs"
---

## High-level description
This Handlebars template file, `VisitDiagnosis.hbs`, is designed to extract and format visit diagnosis information from a Clinical Document Architecture (CDA) document. It specifically targets the CDA section with the template ID '2.16.840.1.113883.10.20.22.2.8', which corresponds to the Assessment and Plan section.

## Code Structure
The template uses nested Handlebars helpers to extract, process, and format the diagnosis data from the CDA document. It outputs a JSON structure containing an array of CodeableConcept objects representing the diagnoses.

## Symbols

### Main Template
#### Description
The main template checks for the presence of a specific CDA section and processes its content to extract diagnosis information.

#### Internal Logic
1. Checks if the input message contains the specific template ID for the Assessment and Plan section.
2. If found, it extracts the first section with that template ID.
3. Iterates through each diagnosis in the extracted section.
4. For each diagnosis, it extracts and maps table data.
5. Creates a JSON structure with a "codes" array containing CodeableConcept objects for each diagnosis.

### Handlebars Helpers Used
- `contains`: Checks if a string contains a specific substring.
- `toString`: Converts a value to a string.
- `toJsonString`: Converts a value to a JSON string.
- `getFirstCdaSectionsByTemplateId`: Extracts the first CDA section with a specific template ID.
- `toArray`: Converts a value to an array.
- `extractAndMapTableData`: Extracts and maps data from a table structure.

### Partial Templates Used
- `DataType/CodeableConcept.hbs`: A partial template used to format the diagnosis information into a CodeableConcept structure.

## Dependencies
This template relies on several custom Handlebars helpers and partial templates, which are not defined in this file but are assumed to be available in the Handlebars environment.

## TODOs
The template includes a comment at the top stating "DO NOT USE THIS YET. IT INTRODUCES DUPLICATES". This suggests that the template may have issues with duplicate data and requires further refinement before being put into production use.

## Error Handling
There is no explicit error handling in this template. It relies on the built-in Handlebars behavior of silently failing and continuing execution when encountering undefined values or errors.

## Performance Considerations
The template uses nested loops and multiple helper functions, which could potentially impact performance for large CDA documents with many diagnoses. Care should be taken to ensure efficient processing of large datasets.

## Notes
1. The template is specifically designed for CDA documents and may not work correctly with other document formats.
2. The output format appears to be designed to work with FHIR resources, specifically the CodeableConcept data type, as evidenced by the use of the CodeableConcept.hbs partial template.
3. The template includes a comprehensive copyright and license notice at the top, indicating its origins and usage terms.