---
title: "pipeline.js"
---

## High-level description
This code implements a `pipeline` function for Node.js streams, ported from the `pump` library. It provides a way to pipe multiple streams together and handle errors and cleanup efficiently, ensuring proper destruction of streams in case of errors or when the pipeline is complete.

## Code Structure
The code defines several utility functions and the main `pipeline` function. The utility functions support the core functionality of `pipeline` by handling stream destruction, error management, and callback execution.

## Symbols

### `once(callback)`
#### Description
Creates a wrapper function that ensures the given callback is only called once.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| callback | Function | The function to be wrapped |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| wrappedCallback | Function | A function that calls the original callback only once |

### `noop(err)`
#### Description
A no-operation function that rethrows any error passed to it.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| err | Error | An optional error object |

### `isRequest(stream)`
#### Description
Checks if a given stream is a request object.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| stream | Object | The stream to check |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| isRequest | Boolean | True if the stream is a request object, false otherwise |

### `destroyer(stream, reading, writing, callback)`
#### Description
Creates a function to safely destroy a stream and handle cleanup.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| stream | Object | The stream to be destroyed |
| reading | Boolean | Indicates if the stream is readable |
| writing | Boolean | Indicates if the stream is writable |
| callback | Function | A callback to be called after destruction |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| destroyFunction | Function | A function that destroys the stream when called |

### `call(fn)`
#### Description
A simple function that calls the provided function.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| fn | Function | The function to be called |

### `pipe(from, to)`
#### Description
Pipes one stream to another.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| from | Stream | The source stream |
| to | Stream | The destination stream |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| destination | Stream | The destination stream |

### `popCallback(streams)`
#### Description
Extracts the callback function from the end of the streams array if present.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| streams | Array | An array of streams, possibly with a callback at the end |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| callback | Function | The extracted callback function or a noop function |

### `pipeline(...streams)`
#### Description
The main function that creates a pipeline of streams, handling errors and cleanup.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| ...streams | Stream[] | A variable number of streams to be piped together |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| pipeline | Stream | The last stream in the pipeline |

#### Internal Logic
1. Extract the callback function from the end of the streams array.
2. Ensure there are at least two streams provided.
3. Create destroyer functions for each stream.
4. Set up error handling and cleanup mechanisms.
5. Reduce the streams array by piping each stream to the next.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| '../../../errors' | For error code constants |
| './end-of-stream' | For the `eos` function to detect when a stream has ended |

## Error Handling
The code implements custom error handling mechanisms:
- Uses `ERR_MISSING_ARGS` when insufficient streams are provided.
- Uses `ERR_STREAM_DESTROYED` when a stream is destroyed during the pipeline operation.
- Propagates errors through the pipeline and ensures all streams are properly destroyed in case of an error.

## Performance Considerations
The `pipeline` function is designed to efficiently handle multiple streams and ensure proper cleanup, which is crucial for managing resources in Node.js applications dealing with streams.