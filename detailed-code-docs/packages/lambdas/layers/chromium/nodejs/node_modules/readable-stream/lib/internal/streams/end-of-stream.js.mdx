---
title: "end-of-stream.js"
---

## High-level description
This code implements an "end-of-stream" (EOS) utility function for Node.js streams. It attaches listeners to various stream events to detect when a stream has ended, finished, or encountered an error, and calls a provided callback function when any of these conditions are met.

## Symbols

### `once(callback)`
#### Description
A utility function that ensures the provided callback is only called once, regardless of how many times the returned function is invoked.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| callback | Function | The function to be wrapped |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| wrappedFunction | Function | A function that will only call the original callback once |

#### Internal Logic
1. Creates a closure with a `called` flag.
2. Returns a function that checks the `called` flag.
3. If `called` is false, sets it to true and invokes the original callback with all provided arguments.

### `noop()`
#### Description
An empty function that does nothing. Used as a default callback.

### `isRequest(stream)`
#### Description
Checks if the given stream is a request object.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| stream | Object | The stream to check |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| isRequest | Boolean | True if the stream is a request object, false otherwise |

### `eos(stream, opts, callback)`
#### Description
The main function that implements the end-of-stream functionality. It attaches various event listeners to the stream to detect when it has ended, finished, or encountered an error.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| stream | Stream | The stream to monitor |
| opts | Object | (Optional) Configuration options |
| callback | Function | The function to call when the stream ends or encounters an error |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| cleanup | Function | A function that removes all attached event listeners |

#### Internal Logic
1. Normalizes input parameters.
2. Determines if the stream is readable and/or writable based on options and stream properties.
3. Defines event handlers for various stream events (finish, end, error, close, etc.).
4. Attaches event listeners to the stream based on its type and properties.
5. Returns a cleanup function that removes all attached event listeners.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| ERR_STREAM_PREMATURE_CLOSE | Custom error type for premature stream closure |

## Error Handling
The code handles premature stream closure by creating and passing an `ERR_STREAM_PREMATURE_CLOSE` error to the callback when appropriate.

## Notes
This code is ported from the `end-of-stream` package by Mathias Buus (@mafintosh) with permission. It provides a robust way to detect when a stream has truly ended, taking into account various edge cases and stream types.