---
title: "_stream_duplex.js"
---

## High-level description
This code defines a `Duplex` stream class, which is both readable and writable. It inherits from the `Readable` stream and incorporates functionality from the `Writable` stream. The `Duplex` class serves as a base for implementing bidirectional streams in Node.js.

## Code Structure
The code defines the `Duplex` class, which inherits from `Readable` and incorporates methods from `Writable`. It also includes several property definitions and utility functions to manage the duplex stream's behavior.

## References
- `./_stream_readable`: The `Readable` stream class
- `./_stream_writable`: The `Writable` stream class
- `inherits`: A utility function for inheritance

## Symbols

### `Duplex`
#### Description
The `Duplex` class represents a stream that is both readable and writable. It inherits from `Readable` and incorporates methods from `Writable`.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| options | Object | Configuration options for the Duplex stream |

#### Internal Logic
1. Calls `Readable.call(this, options)` and `Writable.call(this, options)` to initialize both aspects of the stream.
2. Sets `allowHalfOpen` to `true` by default.
3. Applies options if provided, including setting `readable`, `writable`, and `allowHalfOpen` properties.
4. If `allowHalfOpen` is set to `false`, it attaches an `onend` listener to the 'end' event.

### Property: `writableHighWaterMark`
#### Description
A getter that returns the high water mark of the writable side of the Duplex stream.

### Property: `writableBuffer`
#### Description
A getter that returns the buffer of the writable side of the Duplex stream.

### Property: `writableLength`
#### Description
A getter that returns the length of the writable side of the Duplex stream.

### Property: `destroyed`
#### Description
A getter and setter for the destroyed state of the Duplex stream. It checks both the readable and writable sides.

### `onend`
#### Description
A function that ensures the writable side is ended when the readable side ends, if `allowHalfOpen` is `false`.

### `onEndNT`
#### Description
A helper function used by `onend` to end the writable side in the next tick of the event loop.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| Object.keys | Fallback implementation for getting object keys |
| inherits | Used for inheritance |

## Error Handling
The code doesn't implement specific error handling mechanisms beyond basic exception raising.

## Performance Considerations
The code uses `Object.defineProperty` with `enumerable: false` for certain properties to prevent them from being enumerated in prototype manipulations, which can improve performance in some scenarios.