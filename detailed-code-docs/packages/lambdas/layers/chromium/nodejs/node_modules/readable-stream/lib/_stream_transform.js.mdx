---
title: "_stream_transform.js"
---

## High-level description
This code defines a `Transform` stream class, which is a type of duplex stream that can modify or transform the data as it is written and before it is read. It extends the `Duplex` class and provides a framework for implementing custom transform operations on streaming data.

## Code Structure
The main symbol in this code is the `Transform` class, which inherits from `Duplex`. It includes several methods that work together to handle the transformation process, including `_transform`, `_write`, `_read`, and `_destroy`. The `afterTransform` and `prefinish` functions are helper methods used in the transformation process.

## References
This code references the following external symbols:
- `Duplex` from './_stream_duplex'
- Error codes from '../errors'
- `inherits` function (likely from a utility library)

## Symbols

### Transform
#### Description
The `Transform` class is a duplex stream that allows for data transformation between its readable and writable sides.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| options | Object | Configuration options for the transform stream |

#### Internal Logic
1. Initializes the transform state.
2. Sets up the readable state to request data once transformed.
3. Configures custom `_transform` and `_flush` methods if provided in options.
4. Sets up a 'prefinish' event listener.

### Transform.prototype._transform
#### Description
This method is meant to be overridden in implementation classes to define the actual transformation logic.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| chunk | Buffer/String | The chunk of data to be transformed |
| encoding | String | The encoding of the chunk (if it's a string) |
| cb | Function | Callback to be called when transformation is complete |

#### Internal Logic
The default implementation throws an error indicating that the method needs to be implemented.

### Transform.prototype._write
#### Description
Handles writing data to the transform stream.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| chunk | Buffer/String | The chunk of data to be written |
| encoding | String | The encoding of the chunk (if it's a string) |
| cb | Function | Callback to be called when writing is complete |

#### Internal Logic
1. Stores the write parameters in the transform state.
2. If not currently transforming, it may trigger a read operation.

### Transform.prototype._read
#### Description
Handles read requests from the readable side of the stream.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| n | Number | Number of bytes to read (often ignored) |

#### Internal Logic
1. If there's data to transform and not currently transforming, start transformation.
2. Otherwise, mark that a transform is needed.

### afterTransform
#### Description
Callback function to be called after a transformation is complete.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| er | Error | Any error that occurred during transformation |
| data | Buffer/String | The transformed data |

#### Internal Logic
1. Updates the transform state.
2. Pushes the transformed data to the readable side.
3. Calls the write callback.
4. Potentially triggers another read operation.

### prefinish
#### Description
Handles the 'prefinish' event to flush any remaining data.

#### Internal Logic
1. If a `_flush` method is defined, calls it with a callback to `done`.
2. Otherwise, calls `done` directly.

### done
#### Description
Finalizes the transform stream, pushing any remaining data and ending the readable side.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| stream | Transform | The transform stream |
| er | Error | Any error that occurred |
| data | Buffer/String | Any final data to push |

#### Internal Logic
1. If there's an error, emits an 'error' event.
2. Pushes any final data.
3. Checks for invalid states and throws errors if necessary.
4. Pushes null to end the readable side of the stream.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| '../errors' | Provides error codes used in the module |
| './_stream_duplex' | Provides the Duplex class that Transform extends |
| 'inherits' | Used for setting up prototype inheritance |

## Error Handling
The code includes several error checks:
1. Multiple callback invocation (ERR_MULTIPLE_CALLBACK)
2. Unimplemented _transform method (ERR_METHOD_NOT_IMPLEMENTED)
3. Transforming with length 0 (ERR_TRANSFORM_WITH_LENGTH_0)
4. Already transforming (ERR_TRANSFORM_ALREADY_TRANSFORMING)

These errors are thrown or emitted as appropriate to maintain the integrity of the transform stream's state.