---
title: "destroy.js"
---

## High-level description
This code provides functionality for destroying and undestroying streams, as well as handling errors in streams. It is part of the `readable-stream` library and implements core stream behavior for Node.js-like environments.

## Symbols

### `destroy(err, cb)`
#### Description
This function is responsible for destroying a stream, handling errors, and managing the state of both readable and writable streams.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| err | Error | An optional error object to be passed to callbacks |
| cb | Function | An optional callback function to be called after destruction |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| this | Object | Returns the stream instance for chaining |

#### Internal Logic
1. Checks if the stream is already destroyed (readable or writable).
2. If already destroyed, calls the callback or emits an error.
3. Sets the destroyed state for readable and writable parts.
4. Calls the internal `_destroy` method with error handling and cleanup.
5. Manages error emission and closing of the stream based on various conditions.

### `emitErrorAndCloseNT(self, err)`
#### Description
A helper function that emits an error and closes the stream in the next tick of the event loop.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| self | Object | The stream instance |
| err | Error | The error to be emitted |

### `emitCloseNT(self)`
#### Description
Emits the 'close' event for the stream in the next tick if conditions are met.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| self | Object | The stream instance |

### `undestroy()`
#### Description
Resets the destroyed state and related flags of a stream, effectively "undestroying" it.

### `emitErrorNT(self, err)`
#### Description
Emits an error event for the stream in the next tick.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| self | Object | The stream instance |
| err | Error | The error to be emitted |

### `errorOrDestroy(stream, err)`
#### Description
Decides whether to destroy the stream or emit an error based on the `autoDestroy` flag.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| stream | Object | The stream instance |
| err | Error | The error to be handled |

## Dependencies
This module doesn't explicitly import any external dependencies, but it relies on the Node.js `process` global object for `nextTick` functionality.

## Error Handling
The code implements sophisticated error handling mechanisms:
- It ensures errors are emitted even if the stream is destroyed.
- It manages error emission timing (synchronous vs. next tick) based on stream state.
- It provides options for automatic stream destruction on errors.

## Side Effects
- Modifies the internal state of stream objects.
- Emits 'error' and 'close' events on the stream.
- Uses `process.nextTick` for deferred execution of certain operations.

## Exports
The module exports an object with three methods:
```javascript
module.exports = {
  destroy: destroy,
  undestroy: undestroy,
  errorOrDestroy: errorOrDestroy
};
```

These exported functions provide the core functionality for managing stream lifecycle and error handling in the `readable-stream` library.