---
title: "state.js"
---

## High-level description
This code defines utility functions for handling the highWaterMark option in Node.js streams. It provides a mechanism to retrieve and validate the highWaterMark value from stream options, with special handling for duplex streams.

## Symbols

### `highWaterMarkFrom(options, isDuplex, duplexKey)`
#### Description
This function extracts the highWaterMark value from the provided options object, considering whether it's a duplex stream.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| options | Object | The options object containing stream configuration |
| isDuplex | Boolean | Indicates if the stream is duplex |
| duplexKey | String | The key to use for duplex streams (e.g., 'readableHighWaterMark' or 'writableHighWaterMark') |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| highWaterMark | Number/null | The extracted highWaterMark value or null if not found |

#### Internal Logic
1. Check if `options.highWaterMark` is defined.
2. If it's not defined and it's a duplex stream, return `options[duplexKey]`.
3. Otherwise, return null.

### `getHighWaterMark(state, options, duplexKey, isDuplex)`
#### Description
This function retrieves and validates the highWaterMark value for a stream, providing default values if necessary.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| state | Object | The state object of the stream |
| options | Object | The options object containing stream configuration |
| duplexKey | String | The key to use for duplex streams |
| isDuplex | Boolean | Indicates if the stream is duplex |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| highWaterMark | Number | The validated or default highWaterMark value |

#### Internal Logic
1. Call `highWaterMarkFrom` to get the initial highWaterMark value.
2. If a value is returned:
   a. Validate that it's a finite, non-negative integer.
   b. If invalid, throw an ERR_INVALID_OPT_VALUE error.
   c. If valid, return the floor of the value.
3. If no value is returned, provide a default value:
   a. 16 for object mode streams.
   b. 16 * 1024 (16KB) for non-object mode streams.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| '../../../errors' | Used to import the ERR_INVALID_OPT_VALUE error code |

## Error Handling
The code throws an `ERR_INVALID_OPT_VALUE` error if the provided highWaterMark value is invalid (not a finite, non-negative integer).

## Exports
The module exports an object with a single method:
```javascript
module.exports = {
  getHighWaterMark: getHighWaterMark
};
```

This allows other parts of the codebase to use the `getHighWaterMark` function for determining the appropriate highWaterMark value for streams.