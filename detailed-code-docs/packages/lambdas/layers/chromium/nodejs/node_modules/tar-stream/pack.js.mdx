---
title: "pack.js"
---

## High-level description
This code defines a `Pack` class that implements a tar archive packing functionality. It allows creating tar archives by adding entries (files, directories, symlinks, etc.) and writing them to a stream in the tar format.

## Code Structure
The code defines several classes: `Sink`, `LinkSink`, `Void`, and `Pack`. The `Pack` class is the main class that inherits from `Readable` and provides the core functionality for creating tar archives.

## Symbols

### `Pack`
#### Description
The `Pack` class is responsible for creating tar archives. It extends the `Readable` stream class and provides methods to add entries to the archive and finalize it.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| opts | Object | Options for the Readable stream constructor |

#### Internal Logic
- Initializes internal state variables
- Provides methods for adding entries and finalizing the archive
- Handles different types of entries (files, directories, symlinks, etc.)
- Encodes headers and handles PAX extended headers when necessary

### `Pack.prototype.entry`
#### Description
Adds an entry to the tar archive.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| header | Object | Metadata for the entry |
| buffer | Buffer or String | (Optional) Content of the entry |
| callback | Function | (Optional) Callback function |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| stream | Writable | A writable stream for the entry content |

#### Internal Logic
- Validates and sets default values for the header
- Handles different entry types (file, symlink, directory, etc.)
- Creates appropriate sink streams for writing entry content
- Encodes and writes headers to the archive

### `Pack.prototype.finalize`
#### Description
Finalizes the tar archive by writing the end-of-archive marker.

### `Pack.prototype.destroy`
#### Description
Destroys the Pack instance and cleans up resources.

### `Pack.prototype._encode`
#### Description
Encodes and writes a header to the archive.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| header | Object | Header metadata to encode |

#### Internal Logic
- Attempts to encode the header using standard format
- Falls back to PAX extended header if standard encoding fails

### `Pack.prototype._encodePax`
#### Description
Encodes and writes a PAX extended header to the archive.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| header | Object | Header metadata to encode |

#### Internal Logic
- Creates a PAX header
- Writes the PAX header and its content to the archive

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| fs-constants | Provides file system constants |
| end-of-stream | Handles stream end events |
| inherits | Implements inheritance |
| readable-stream | Provides Readable and Writable stream classes |
| string_decoder | Decodes buffer to string |
| ./headers | Handles tar header encoding |

## Error Handling
The code implements error handling in various methods, particularly in the `entry` method where it checks for size mismatches and stream closure errors. Errors are propagated through callbacks or by destroying the Pack instance.

## Performance Considerations
The code uses Buffer operations and stream processing, which are generally efficient for handling large amounts of data. The use of `process.nextTick()` in some places ensures non-blocking behavior.