---
title: "chownr.js"
---

## High-level description
This code implements a recursive chown (change owner) functionality for directories and files. It provides both synchronous and asynchronous versions of the operation, handling various edge cases and compatibility issues across different Node.js versions.

## Code Structure
The code defines several utility functions and the main `chownr` and `chownrSync` functions. These functions use Node.js's built-in `fs` module to perform file system operations. The code also includes various checks and fallbacks to ensure compatibility across different Node.js versions.

## Symbols

### `lchownSync(path, uid, gid)`
#### Description
A wrapper function for `fs.lchownSync` or `fs.chownSync` that ignores ENOENT errors.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| path | string | The path to the file or directory |
| uid | number | The numeric user id to set as the owner |
| gid | number | The numeric group id to set as the group |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| undefined | undefined | Returns undefined if successful |

#### Internal Logic
- Attempts to change the owner of the file or directory using `fs[LCHOWNSYNC]`
- If an ENOENT error occurs (file not found), it's ignored
- Other errors are thrown

### `chownSync(path, uid, gid)`
#### Description
A wrapper function for `fs.chownSync` that ignores ENOENT errors.

(Similar structure to `lchownSync`, with `fs.chownSync` used instead)

### `handleEISDIR(path, uid, gid, cb)`
#### Description
A function to handle EISDIR errors for Node.js versions prior to v10.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| path | string | The path to the file or directory |
| uid | number | The numeric user id to set as the owner |
| gid | number | The numeric group id to set as the group |
| cb | function | Callback function to be called after the operation |

#### Internal Logic
- If the error is EISDIR (is a directory), it falls back to using `fs.chown`
- For other errors or success, it calls the callback

### `handleEISDirSync(path, uid, gid)`
#### Description
A synchronous version of `handleEISDIR`.

### `chown(cpath, uid, gid, cb)`
#### Description
A wrapper function for `fs[LCHOWN]` that handles EISDIR errors and ignores ENOENT errors.

### `chownrKid(p, child, uid, gid, cb)`
#### Description
Recursively changes the ownership of a child item (file or directory).

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| p | string | The parent directory path |
| child | string or fs.Stats | The child item (name or stats object) |
| uid | number | The numeric user id to set as the owner |
| gid | number | The numeric group id to set as the group |
| cb | function | Callback function to be called after the operation |

#### Internal Logic
- If `child` is a string, it first gets the stats for the child
- If the child is a directory, it recursively calls `chownr` on it
- Otherwise, it calls `chown` on the child

### `chownr(p, uid, gid, cb)`
#### Description
The main asynchronous function to recursively change ownership of a directory and its contents.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| p | string | The path to the directory |
| uid | number | The numeric user id to set as the owner |
| gid | number | The numeric group id to set as the group |
| cb | function | Callback function to be called after the operation |

#### Internal Logic
- Reads the directory contents
- Handles various error cases (ENOENT, ENOTDIR, ENOTSUP)
- For each child in the directory, calls `chownrKid`
- After processing all children, calls `chown` on the directory itself

### `chownrKidSync(p, child, uid, gid)`
#### Description
Synchronous version of `chownrKid`.

### `chownrSync(p, uid, gid)`
#### Description
The main synchronous function to recursively change ownership of a directory and its contents.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| p | string | The path to the directory |
| uid | number | The numeric user id to set as the owner |
| gid | number | The numeric group id to set as the group |

#### Internal Logic
- Reads the directory contents synchronously
- Handles various error cases (ENOENT, ENOTDIR, ENOTSUP)
- For each child in the directory, calls `chownrKidSync`
- Finally, calls `handleEISDirSync` on the directory itself

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| fs | Node.js built-in module for file system operations |
| path | Node.js built-in module for handling file paths |

## Error Handling
The code implements specific error handling for:
- ENOENT (file or directory not found): generally ignored
- EISDIR (is a directory): handled differently for older Node.js versions
- ENOTDIR (not a directory) and ENOTSUP (operation not supported): handled in main functions

## Performance Considerations
The code uses asynchronous operations where possible to avoid blocking the event loop. It also implements a recursive algorithm, which could potentially cause stack overflow for deeply nested directory structures.