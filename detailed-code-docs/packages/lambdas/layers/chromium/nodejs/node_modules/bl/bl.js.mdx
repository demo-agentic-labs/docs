---
title: "bl.js"
---

## High-level description
This code defines a `BufferListStream` class, which is a duplex stream that manages a list of buffers. It extends the functionality of `BufferList` and implements the `Duplex` stream interface, allowing for both reading and writing of data.

## Code Structure
The main symbol is the `BufferListStream` class, which inherits from `DuplexStream` and incorporates functionality from `BufferList`. It provides methods for writing, reading, and managing buffers in a stream-like manner.

## References
- `readable-stream`: Used for the `Duplex` stream functionality
- `inherits`: Used for inheritance
- `./BufferList`: A related module that provides buffer list functionality

## Symbols

### BufferListStream
#### Description
A class that implements a duplex stream for managing a list of buffers. It combines the functionality of `BufferList` with stream capabilities.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| callback | function | Optional callback function to be called when the stream ends or encounters an error |

#### Internal Logic
1. Initializes the `BufferList` functionality
2. Sets up error handling for piped streams if a callback is provided
3. Implements `_write`, `_read`, `end`, and `_destroy` methods to handle stream operations
4. Provides utility methods like `_new` and `_isBufferList`

### BufferListStream.prototype._write
#### Description
Writes a buffer to the stream.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| buf | Buffer | The buffer to write |
| encoding | string | The encoding of the buffer (unused) |
| callback | function | Optional callback to be called after writing |

#### Internal Logic
1. Appends the buffer to the internal buffer list
2. Calls the callback if provided

### BufferListStream.prototype._read
#### Description
Reads data from the stream.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| size | number | The number of bytes to read |

#### Internal Logic
1. If there's no data, push null to signal end of stream
2. Read the minimum of `size` or available data length
3. Push the read data to the stream
4. Consume the read data from the buffer list

### BufferListStream.prototype.end
#### Description
Ends the stream and calls the callback if provided.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| chunk | Buffer | Optional final chunk of data to write |

#### Internal Logic
1. Call the parent `end` method
2. If a callback is set, call it with the entire buffer contents and clear the callback

### BufferListStream.prototype._destroy
#### Description
Destroys the stream, clearing all buffers.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| err | Error | Error that caused the destruction (if any) |
| cb | function | Callback to be called after destruction |

#### Internal Logic
1. Clear the internal buffer list
2. Reset the length to 0
3. Call the provided callback with the error

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| readable-stream | Provides the `Duplex` stream functionality |
| inherits | Used for implementing inheritance |
| ./BufferList | Provides the base BufferList functionality |

## Error Handling
The code implements error handling for piped streams when a callback is provided. It attaches an error listener to the source stream when it's piped, and removes the listener when it's unpiped.

## API/Interface Reference
The module exports the `BufferListStream` class as both the default export and a named export. It also exports the `BufferList` class as a named export.

| Export | Type | Description |
|:-------|:-----|:------------|
| BufferListStream | Class | The main BufferListStream class |
| BufferList | Class | The base BufferList class |

The `BufferListStream` class provides a duplex stream interface for managing buffer lists, with methods for reading, writing, and manipulating buffers in a stream-like manner.