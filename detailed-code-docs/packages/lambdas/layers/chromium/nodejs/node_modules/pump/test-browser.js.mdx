---
title: "test-browser.js"
---

## High-level description
This code is a browser-based test for the `pump` function, which is used for piping multiple streams together. It creates a readable stream, a writable stream, and several transform streams, then uses `pump` to connect them all and verify the correct behavior.

## Code Structure
The code sets up test streams, defines helper functions, and uses the `pump` function to connect the streams. It then checks for proper closure of streams and callback execution.

## References
This code references the `pump` function from './index.js', which is provided in the related code snippets.

## Symbols

### `stream.Readable` and `stream.Writable`
#### Description
These are Node.js stream classes used to create readable and writable streams for testing.

### `rs._read`
#### Description
Custom implementation of the `_read` method for the readable stream. It pushes a buffer filled with 'abc' characters.

### `ws._write`
#### Description
Custom implementation of the `_write` method for the writable stream. It simulates an asynchronous write operation with a 100ms delay.

### `toHex`
#### Description
A function that creates a transform stream. This stream converts incoming chunks to their hexadecimal representation.

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| reverse | stream.Transform | A transform stream that converts input to hexadecimal |

### `check`
#### Description
A function that checks if all conditions (writable stream closed, readable stream closed, and callback called) are met. If so, it logs a success message and clears the timeout.

### `pump`
#### Description
The main function being tested. It pipes multiple streams together and handles errors and closures.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| rs | stream.Readable | The source readable stream |
| toHex() | stream.Transform | Multiple transform streams that convert to hexadecimal |
| ws | stream.Writable | The destination writable stream |
| callback | function | A callback function to be called when pumping is complete |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| res | stream | The last stream in the pipeline (should be `ws`) |

## Side Effects
- Modifies global variables `wsClosed`, `rsClosed`, and `callbackCalled`.
- Logs to the console when the test passes.
- Sets and clears timeouts.

## Error Handling
The code includes a timeout that will throw an error if the test doesn't complete within 5 seconds.

## Testing Logic
1. Sets up readable and writable streams with custom implementations.
2. Creates a `toHex` transform stream.
3. Uses `pump` to connect the readable stream, three `toHex` transforms, and the writable stream.
4. Sets up event listeners for stream closure and end.
5. Pushes `null` to the readable stream after 1 second to signal the end of input.
6. Checks if all streams are properly closed and the callback is called.
7. Throws an error if the test doesn't complete within 5 seconds.

The test passes if all streams are closed properly, the callback is called, and no timeout occurs.