---
title: "Overview"
---

## High-level description
This code implements a `StringDecoder` class that efficiently converts buffers into JavaScript strings while handling multi-byte characters correctly. It supports various encodings such as UTF-8, UTF-16LE, Base64, and single-byte encodings like ASCII and Latin1.

## Code Structure
The main symbol is the `StringDecoder` class, which contains methods for writing and ending buffer decoding. Several helper functions are defined to handle specific encoding types and edge cases.

## Symbols

### StringDecoder
#### Description
A class that decodes buffers into strings, handling various encodings and maintaining state for partial multi-byte characters.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| encoding | string | The encoding to use for decoding (e.g., 'utf8', 'utf16le', 'base64') |

#### Internal Logic
- Normalizes the encoding input
- Sets up appropriate internal methods based on the encoding
- Maintains state for partial characters (lastNeed, lastTotal, lastChar)

### StringDecoder.prototype.write
#### Description
Decodes a buffer into a string, handling partial characters from previous writes.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| buf | Buffer | The buffer to decode |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| result | string | The decoded string |

#### Internal Logic
- Handles any leftover partial characters from previous writes
- Decodes the buffer using the appropriate method for the encoding

### StringDecoder.prototype.end
#### Description
Finishes the decoding process, handling any remaining partial characters.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| buf | Buffer | (Optional) Final buffer to decode |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| result | string | The final decoded string |

### utf8CheckByte
#### Description
Checks the type of a UTF-8 byte.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| byte | number | The byte to check |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| result | number | 0 for ASCII, 2-4 for leading bytes, -1 for continuation bytes, -2 for invalid bytes |

### utf8CheckIncomplete
#### Description
Checks for incomplete multi-byte UTF-8 characters at the end of a buffer.

### utf8CheckExtraBytes
#### Description
Validates continuation bytes for multi-byte UTF-8 characters.

### utf8FillLast
#### Description
Attempts to complete a multi-byte UTF-8 character using bytes from a buffer.

### utf8Text
#### Description
Decodes complete UTF-8 characters from a buffer, buffering partial characters.

### utf8End
#### Description
Handles the end of UTF-8 decoding, adding a replacement character for partial characters.

### utf16Text
#### Description
Decodes UTF-16LE text from a buffer, handling surrogate pairs.

### utf16End
#### Description
Handles the end of UTF-16LE decoding.

### base64Text
#### Description
Decodes Base64 text from a buffer, handling partial groups.

### base64End
#### Description
Handles the end of Base64 decoding.

### simpleWrite
#### Description
Decodes single-byte encodings (e.g., ASCII, Latin1, Hex).

### simpleEnd
#### Description
Handles the end of single-byte encoding decoding.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| safe-buffer | Provides a safer Buffer implementation |

## Error Handling
The code throws an error if an unknown encoding is provided. It also handles invalid UTF-8 sequences by replacing them with the Unicode replacement character (U+FFFD).