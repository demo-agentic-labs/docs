---
title: "bulk-trigger-patient-discovery.ts"
---

## High-level description
This code is a utility script designed to trigger patient discovery for a specified list of patient IDs. It interacts with an API endpoint to initiate the patient discovery process, handling the requests in batches to manage load and avoid overwhelming the system.

## Code Structure
The main function `main()` orchestrates the entire process, calling helper functions like `displayInitialWarningAndConfirmation()` and using utility functions from imported libraries. The script processes patient IDs in chunks, making API calls for each patient and implementing delays between chunks to manage the load on the system.

## Symbols

### `main()`
#### Description
The main function that orchestrates the patient discovery process for the specified patient IDs.

#### Internal Logic
1. Displays an initial warning and confirmation message.
2. Chunks the patient IDs into smaller groups.
3. Iterates through each chunk of patient IDs:
   - For each patient in the chunk, makes an API call to trigger patient discovery.
   - Implements a delay between chunks to manage system load.
4. Handles any errors that occur during the process.

### `displayInitialWarningAndConfirmation(numberPatients: number)`
#### Description
Displays a warning message and waits for a specified time before proceeding with the patient discovery process.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| numberPatients | number | The total number of patients to process |

#### Internal Logic
1. Prints a warning message in red.
2. Displays information about the number of patients and the customer ID.
3. Waits for a specified delay time before returning.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| dotenv | Load environment variables from a .env file |
| @metriport/core/util/env-var | Retrieve environment variables |
| @metriport/core/util/log | Logging utility |
| @metriport/shared | Provides the `sleep` function |
| axios | Make HTTP requests |
| dayjs | Date and time manipulation |
| lodash | Provides the `chunk` function for array manipulation |

## Configuration
| Option | Type | Default | Description |
|:-------|:-----|:--------|:------------|
| CX_ID | string | N/A | Customer ID (environment variable) |
| API_URL | string | N/A | API URL (environment variable) |
| CHUNK_DELAY_MAX_MS | number | 1000 | Maximum delay between chunks in milliseconds |
| PATIENT_CHUNK_SIZE | number | 5 | Number of patients to process in each chunk |

## Error Handling
The main function is wrapped in a try-catch block to catch and log any errors that occur during the process.

## Performance Considerations
The script implements chunking and delays between API calls to manage the load on the system and avoid overwhelming the API endpoint. The `CHUNK_DELAY_MAX_MS` and `PATIENT_CHUNK_SIZE` constants can be adjusted to fine-tune the performance based on system capabilities and API limitations.