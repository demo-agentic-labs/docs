---
title: "test_start_consolidated_query,.ts"
---

## High-level description
This code is a test suite for the Consolidated Query functionality of the Metriport API. It tests the process of starting a consolidated query, checking its status, and counting patient data using the MetriportClient.

## Code Structure
The code sets up the environment, initializes the MetriportClient, and then defines a test case that performs a series of API calls to test the consolidated query functionality.

## Symbols

### `describe("Consolidated Query tests", () =&gt; { ... })`
#### Description
This is a Jest test suite that groups related tests for the Consolidated Query functionality.

### `test("start consolidated query", async () =&gt; { ... })`
#### Description
This is a single test case that performs a series of API calls to test the consolidated query process.

#### Internal Logic
1. Checks the initial query status
2. Starts a consolidated query with specific parameters
3. Checks the query status immediately after starting
4. Waits for 5 seconds
5. Checks the query status again
6. Counts the patient data

#### Performance Considerations
The test includes a 5-second delay (`setTimeout`) to allow time for the query to process. This might need adjustment based on actual API response times.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| dotenv | For loading environment variables |
| path | For resolving file paths |
| MetriportClient | The main client for interacting with the Metriport API |
| GetPatientConsolidatedData | Type definition for the consolidated query request |

## Configuration
| Option | Type | Default | Description |
|:-------|:-----|:--------|:------------|
| apiUrl | string | process.env.BASE_URL | The base URL for the Metriport API |
| apiToken | string | process.env.API_KEY | The API key for authentication |
| patientId | string | process.env.PATIENT_ID | The ID of the patient for the query |

## Error Handling
The code includes basic error handling by checking if required environment variables are set. If not, it throws an error.

```typescript
if (!apiUrl || !apiToken || !patientId) {
  throw new Error("Required environment variables are not set");
}
```

## Logging
The code uses `console.log` statements to log the progress and results of each API call for debugging purposes.

## TODOs
- The test timeout is set to 10000ms (10 seconds). This might need adjustment based on actual API response times and the 5-second delay in the test.
- Consider adding more assertions to validate the responses from the API calls.
- The error handling could be improved to catch and handle potential API errors.