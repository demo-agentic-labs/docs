---
title: "test_start_consolidated_query.py"
---

## High-level description
This code is a test script for the Metriport API, specifically testing the consolidated query functionality. It demonstrates how to start a consolidated query, check its status, and count patient data using the Metriport Python SDK.

## Symbols

### `test_start_consolidated_query()`
#### Description
This function is the main test case that demonstrates the usage of various Metriport API endpoints related to consolidated queries and patient data.

#### Internal Logic
1. Initialize the Metriport client with API key and base URL.
2. Check the initial consolidated query status for a patient.
3. Start a new consolidated query with specific parameters.
4. Check the query status immediately after starting.
5. Wait for 5 seconds.
6. Check the query status again.
7. Count the patient data.

#### Side Effects
- Prints various status messages and API responses to the console.
- Makes multiple API calls to the Metriport service.
- Introduces a 5-second delay using `time.sleep()`.

## Dependencies
| Dependency | Purpose |
|:-----------|:--------|
| os | Accessing environment variables |
| time | Introducing delays in the script |
| dotenv | Loading environment variables from a .env file |
| json | Pretty-printing JSON responses |
| generated.client | Importing the Metriport client |

## Configuration
| Option | Type | Default | Description |
|:-------|:-----|:--------|:------------|
| API_KEY | string | None | API key for authenticating with Metriport |
| PATIENT_ID | string | None | ID of the patient for which queries are performed |
| BASE_URL | string | None | Base URL for the Metriport API |

## Error Handling
This script does not implement explicit error handling. Any exceptions raised by the API calls or other operations will propagate and potentially terminate the script.

## Logging
The script uses `print()` statements to log the progress and results of various API calls. This is not a formal logging mechanism but serves to provide visibility into the test execution.

## Notes
1. The script assumes that the necessary environment variables (API_KEY, PATIENT_ID, BASE_URL) are set in a .env file or in the system environment.
2. The consolidated query is started with specific parameters: resources are limited to "DocumentReference" and "Appointment", and a date range is specified.
3. The script demonstrates the asynchronous nature of the consolidated query process by checking the status multiple times with a delay in between.
4. The `count_patient_data()` call at the end suggests that the script is also verifying the presence of patient data after the consolidated query process.

This script appears to be a manual test or demonstration of the Metriport API's consolidated query functionality, rather than an automated unit test, due to the lack of assertions and the use of print statements for output.