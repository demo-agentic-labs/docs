---
title: "commons.ts"
---

## High-level description
This code provides utility functions and types for converting FHIR (Fast Healthcare Interoperability Resources) data to CDA (Clinical Document Architecture) format. It includes various helper functions for building CDA elements, formatting dates, and mapping between FHIR and CDA concepts.

## Code Structure
The main symbols in this code are utility functions that are used across different parts of the FHIR to CDA conversion process. These functions are designed to be reusable and handle common tasks such as building CDA codes, identifiers, and addresses. The code also defines several types and interfaces used in the CDA structure.

## Symbols

### `buildCodeCeFromCoding`
#### Description
Builds a CDA CodeCe object from a FHIR Coding.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| coding | Coding \| Coding[] \| undefined | FHIR Coding object(s) |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| return | CdaCodeCe \| undefined | CDA CodeCe object |

### `buildCodeCe`
#### Description
Builds a CDA CodeCe object from provided parameters.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| code | string \| undefined | Code value |
| codeSystem | string \| undefined | Code system |
| codeSystemName | string \| undefined | Code system name |
| displayName | string \| undefined | Display name |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| return | CdaCodeCe | CDA CodeCe object |

### `buildCodeCvFromCodeableConcept`
#### Description
Builds a CDA CodeCv object from a FHIR CodeableConcept.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| codeableConcept | CodeableConcept \| CodeableConcept[] \| undefined | FHIR CodeableConcept object(s) |
| textReference | string \| undefined | Text reference |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| return | CdaCodeCv \| undefined | CDA CodeCv object |

### `formatDateToCdaTimestamp`
#### Description
Formats a date string to a CDA timestamp format.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| dateString | string \| undefined | Date string to format |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| return | string \| undefined | Formatted CDA timestamp |

### `formatDateToHumanReadableFormat`
#### Description
Formats a date string to a human-readable format.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| dateString | string \| undefined | Date string to format |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| return | string \| undefined | Formatted human-readable date |

## Dependencies
The code relies on several external libraries and modules:
| Dependency | Purpose |
|:-----------|:--------|
| @medplum/fhirtypes | Provides FHIR type definitions |
| @metriport/shared | Provides utility functions |
| dayjs | Date manipulation library |

## Configuration
The code defines several constants and mappings used in the conversion process:
| Option | Type | Description |
|:-------|:-----|:------------|
| CODING_MAP | Map&lt;string, string&gt; | Maps FHIR coding systems to CDA coding systems |
| TIMESTAMP_CLEANUP_REGEX | RegExp | Regular expression for cleaning up timestamps |

## Error Handling
The code uses optional chaining and nullish coalescing operators to handle potential undefined or null values. It also includes helper functions like `withNullFlavor` and `withoutNullFlavorObject` to handle missing data in a CDA-compliant way.

## Logging
This code does not implement any specific logging mechanisms.

## TODOs
- TODO: Use term server to include a LOINC code
- TODO: Use term server to get the actual LOINC code

This code provides a robust set of utility functions for converting FHIR data to CDA format, handling various data types and structures commonly found in healthcare information exchange.