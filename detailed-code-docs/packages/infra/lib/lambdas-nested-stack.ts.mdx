---
title: "lambdas-nested-stack.ts"
---

## High-level description
This code defines a `LambdasNestedStack` class that creates and configures various AWS Lambda functions for a Metriport API infrastructure. It sets up Lambda functions for tasks such as CDA to visualization conversion, document downloading, FHIR to CDA conversion, and outbound patient discovery and document retrieval operations.

## Code Structure
The `LambdasNestedStack` class extends `NestedStack` and contains methods to set up different Lambda functions. Each method creates a Lambda function with specific configurations, including VPC settings, environment variables, and necessary permissions. The class also manages shared resources like Lambda layers and S3 buckets.

## Symbols

### `LambdasNestedStack`
#### Description
This class represents a nested stack for creating and managing various Lambda functions used in the Metriport API infrastructure.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| scope | Construct | The parent construct |
| id | string | The ID of the stack |
| props | LambdasNestedStackProps | Configuration properties for the stack |

#### Internal Logic
1. Sets up Lambda layers
2. Creates various Lambda functions (CDA to visualization, document downloader, FHIR to CDA converter, etc.)
3. Configures each Lambda function with appropriate settings, permissions, and environment variables

### `setupCdaToVisualization`
#### Description
Sets up the CDA to Visualization Lambda function.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| ownProps | Object | Configuration properties for the Lambda function |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| cdaToVisualizationLambda | Lambda | The created Lambda function |

### `setupDocumentDownloader`
#### Description
Sets up the Document Downloader Lambda function.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| ownProps | Object | Configuration properties for the Lambda function |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| documentDownloaderLambda | Lambda | The created Lambda function |

### `setupFhirToCdaConverterLambda`
#### Description
Sets up the FHIR to CDA Converter Lambda function.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| ownProps | Object | Configuration properties for the Lambda function |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| fhirToCdaConverterLambda | Lambda | The created Lambda function |

### `setupOutboundPatientDiscovery`
#### Description
Sets up the Outbound Patient Discovery Lambda function.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| ownProps | Object | Configuration properties for the Lambda function |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| outboundPatientDiscoveryLambda | Lambda | The created Lambda function |

### `setupOutboundDocumentQuery`
#### Description
Sets up the Outbound Document Query Lambda function.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| ownProps | Object | Configuration properties for the Lambda function |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| outboundDocumentQueryLambda | Lambda | The created Lambda function |

### `setupOutboundDocumentRetrieval`
#### Description
Sets up the Outbound Document Retrieval Lambda function.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| ownProps | Object | Configuration properties for the Lambda function |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| outboundDocumentRetrievalLambda | Lambda | The created Lambda function |

### `setupFhirBundleLambda`
#### Description
Sets up the FHIR Bundle Lambda function.

#### Inputs
| Name | Type | Description |
|:-----|:-----|:------------|
| props | Object | Configuration properties for the Lambda function |

#### Outputs
| Name | Type | Description |
|:-----|:-----|:------------|
| fhirToBundleLambda | Lambda | The created Lambda function |

## Dependencies
- aws-cdk-lib
- constructs
- Various AWS services (EC2, Lambda, RDS, S3, SecretsManager, etc.)

## Configuration
The stack uses an `EnvConfig` object for configuration, which includes environment-specific settings such as VPC, secrets, database cluster, and S3 buckets.

## Error Handling
The code includes basic error handling, such as throwing errors when required secrets are not defined. However, most error handling is likely delegated to the individual Lambda functions.

## Logging
Logging is not explicitly implemented in this stack but is likely handled within the individual Lambda functions.

## TODOs
- Move the maximum polling duration to a config file for outbound patient discovery, document query, and document retrieval Lambdas.